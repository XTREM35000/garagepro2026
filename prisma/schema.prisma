generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider      = "postgresql"
  url           = env("DATABASE_URL")
  directUrl     = env("DIRECT_URL")
}

model Tenant {
  id            String         @id @default(uuid()) @db.Uuid
  name          String
  address       String?
  logoUrl       String?
  rccm          String?
  plan          String         @default("basic")
  stripeId      String?        @unique
  trialEnds     DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  isPlatform    Boolean        @default(false)
  cashRegisters CashRegister[]
  expenses      Expense[]
  invoices      Invoice[]
  stockItems    StockItem[]
  subscriptions Subscription[]
  users         User[]
  vehicles      Vehicle[]
  interventions Intervention[]

  @@index([stripeId])
}

model User {
  id              String         @id @default(uuid()) @db.Uuid
  name            String?
  avatarUrl       String?
  tenantId        String         @db.Uuid
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  email           String         @unique
  password        String
  role            UserRole       @default(VIEWER)
  cashRegisters   CashRegister[] @relation("UserCashRegisters")
  expenses        Expense[]      @relation("UserExpenses")
  invoices        Invoice[]      @relation("UserInvoices")
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  photos          VehiclePhoto[]
  interventions   Intervention[] @relation("TechnicianInterventions")

  @@index([tenantId])
  @@index([role])
  @@map("User")
}

model Vehicle {
  id            String         @id @default(uuid()) @db.Uuid
  marque        String
  modele        String
  immatricule   String         @unique
  tenantId      String         @db.Uuid
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  status        VehicleStatus  @default(EN_COURS)
  invoices      Invoice[]
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  photos        VehiclePhoto[]
  interventions Intervention[]

  @@index([tenantId])
  @@index([status])
}

model VehiclePhoto {
  id        String           @id @default(uuid()) @db.Uuid
  url       String
  takenById String?          @db.Uuid
  vehicleId String           @db.Uuid
  createdAt DateTime         @default(now())
  updatedAt DateTime         @default(now())
  type      VehiclePhotoType
  takenBy   User?            @relation(fields: [takenById], references: [id])
  vehicle   Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([takenById])
}

model StockItem {
  id          String   @id @default(uuid()) @db.Uuid
  nom         String
  categorie   String
  quantite    Int
  prixAchat   Decimal
  prixVente   Decimal
  seuilAlerte Int
  tenantId    String   @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([categorie])
}

model CashRegister {
  id        String   @id @default(uuid()) @db.Uuid
  montant   Decimal
  motif     String
  faitParId String?  @db.Uuid
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  type      CashType
  faitPar   User?    @relation("UserCashRegisters", fields: [faitParId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([faitParId])
  @@index([type])
}

model Invoice {
  id          String        @id @default(uuid()) @db.Uuid
  numero      String        @unique
  total       Decimal
  vehicleId   String?       @db.Uuid
  clientNom   String
  clientTel   String?
  createdById String?       @db.Uuid
  tenantId    String        @db.Uuid
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  statut      InvoiceStatus @default(BROUILLON)
  createdBy   User?         @relation("UserInvoices", fields: [createdById], references: [id])
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle     Vehicle?      @relation(fields: [vehicleId], references: [id])

  @@index([tenantId])
  @@index([vehicleId])
  @@index([statut])
}

model Subscription {
  id                   String             @id @default(uuid()) @db.Uuid
  plan                 String
  stripeCustomerId     String?
  stripeSubscriptionId String?
  tenantId             String             @db.Uuid
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  status               SubscriptionStatus
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
}

model Expense {
  id        String   @id @default(uuid()) @db.Uuid
  libelle   String
  montant   Decimal
  categorie String
  faitParId String?  @db.Uuid
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  faitPar   User?    @relation("UserExpenses", fields: [faitParId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([faitParId])
}

enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  AGENT
  VIEWER
}

enum VehicleStatus {
  EN_COURS
  TERMINE
  LIVRE
}

enum VehiclePhotoType {
  ENTREE
  SORTIE
  DEGAT
}

enum CashType {
  ENTREE
  SORTIE
}

enum InvoiceStatus {
  BROUILLON
  PAYEE
  ANNULEE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRE
  EN_ATTENTE
}

model Intervention {
  id                 String                @id @default(cuid())
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  tenantId           String                @db.Uuid
  tenant             Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicleId          String                @db.Uuid
  vehicle            Vehicle               @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  technicianId       String?               @db.Uuid
  technician         User?                 @relation("TechnicianInterventions", fields: [technicianId], references: [id])
  
  status             InterventionStatus    @default(EN_ATTENTE)
  priority           InterventionPriority  @default(NORMALE)
  progress           Int                   @default(0)
  
  title              String
  description        String?
  diagnosis          String?
  observations       String?
  
  startDate          DateTime?
  estimatedEndDate   DateTime?
  actualEndDate      DateTime?
  
  estimatedCost      Decimal?              @db.Decimal(10, 2)
  actualCost         Decimal?              @db.Decimal(10, 2)
  partsCost          Decimal?              @db.Decimal(10, 2)
  laborCost          Decimal?              @db.Decimal(10, 2)
  
  usedParts          UsedPart[]
  timeEntries        TimeEntry[]
  photos             InterventionPhoto[]

  @@index([tenantId])
  @@index([vehicleId])
  @@index([technicianId])
  @@index([status])
  @@map("interventions")
}

model UsedPart {
  id             String       @id @default(cuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  
  partName       String
  quantity       Int
  unitPrice      Decimal      @db.Decimal(10, 2)
  totalPrice     Decimal      @db.Decimal(10, 2)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([interventionId])
}

model TimeEntry {
  id             String       @id @default(cuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  
  startTime      DateTime
  endTime        DateTime?
  duration       Int?         // en minutes
  description    String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([interventionId])
}

model InterventionPhoto {
  id             String       @id @default(cuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  
  url            String
  type           String       // AVANT, APRES, PROBLEME
  description    String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([interventionId])
}

enum InterventionStatus {
  EN_ATTENTE
  DIAGNOSTIC
  DEVIS_ENVOYE
  EN_COURS
  TERMINE
  FACTURE
  PAYE
}

enum InterventionPriority {
  BASSE
  NORMALE
  HAUTE
  URGENTE
}
