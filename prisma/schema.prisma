generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider      = "postgresql"
  url           = env("DATABASE_URL")
  directUrl     = env("DIRECT_URL")
}

model Tenant {
  id            String         @id @default(uuid())
  name          String
  address       String?
  logoUrl       String?
  rccm          String?
  phone         String?
  email         String?
  website       String?
  businessHours String?
  plan          String         @default("basic")
  stripeId      String?        @unique
  trialEnds     DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  isPlatform    Boolean        @default(false)
  superAdminId  String?
  cashRegisters CashRegister[]
  expenses      Expense[]
  invoices      Invoice[]
  stockItems    StockItem[]
  subscriptions Subscription[]
  users         User[]
  vehicles      Vehicle[]
  interventions Intervention[]
  clients       Client[]
  superAdmin    User?          @relation("SuperAdminTenants", fields: [superAdminId], references: [id], onDelete: SetNull)

  @@index([stripeId])
  @@index([superAdminId])
  @@index([name])
}

model User {
  id              String         @id @default(uuid())
  name            String?
  avatarUrl       String?
  email           String         @unique
  password        String
  phone           String?
  specialty       String?
  hireDate        DateTime?
  status          UserStatus     @default(active)
  tenantId        String?
  role            UserRole       @default(viewer)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  cashRegisters   CashRegister[] @relation("UserCashRegisters")
  expenses        Expense[]      @relation("UserExpenses")
  invoices        Invoice[]      @relation("UserInvoices")
  tenant          Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  managedTenants  Tenant[]       @relation("SuperAdminTenants")
  photos          VehiclePhoto[]
  interventions   Intervention[] @relation("TechnicianInterventions")
  receivedReceptions Reception[]

  @@index([tenantId])
  @@index([role])
  @@index([status])
  @@index([specialty])
  @@map("User")
}

model Vehicle {
  id            String         @id @default(uuid())
  marque        String
  modele        String
  immatricule   String         @unique
  annee         Int?
  couleur       String?
  kilometrage   Int?
  carburant     String?
  chassis       String?
  tenantId      String
  clientId      String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  status        VehicleStatus  @default(en_cours)
  invoices      Invoice[]
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client        Client?        @relation("ClientVehicles", fields: [clientId], references: [id])
  photos        VehiclePhoto[]
  interventions Intervention[]
  receptions    Reception[]

  @@index([tenantId])
  @@index([clientId])
  @@index([status])
  @@index([marque])
}

model VehiclePhoto {
  id        String           @id @default(uuid())
  url       String
  takenById String?
  vehicleId String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @default(now())
  type      VehiclePhotoType
  takenBy   User?            @relation(fields: [takenById], references: [id])
  vehicle   Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([takenById])
}

model StockItem {
  id          String   @id @default(uuid())
  nom         String
  categorie   String
  quantite    Int
  prixAchat   Decimal
  prixVente   Decimal
  seuilAlerte Int
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([categorie])
}

model CashRegister {
  id        String   @id @default(uuid())
  montant   Decimal
  motif     String
  faitParId String?
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  type      CashType
  faitPar   User?    @relation("UserCashRegisters", fields: [faitParId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([faitParId])
  @@index([type])
}

model Invoice {
  id          String        @id @default(uuid())
  numero      String        @unique
  total       Decimal
  vehicleId   String?
  clientId    String?
  createdById String?
  tenantId    String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  statut      InvoiceStatus @default(brouillon)
  createdBy   User?         @relation("UserInvoices", fields: [createdById], references: [id])
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle     Vehicle?      @relation(fields: [vehicleId], references: [id])
  client      Client?       @relation(fields: [clientId], references: [id])

  @@index([tenantId])
  @@index([vehicleId])
  @@index([clientId])
  @@index([statut])
}

model Subscription {
  id                   String             @id @default(uuid())
  plan                 String
  stripeCustomerId     String?
  stripeSubscriptionId String?
  tenantId             String
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  status               SubscriptionStatus
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
}

model Expense {
  id        String   @id @default(uuid())
  libelle   String
  montant   Decimal
  categorie String
  faitParId String?
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  faitPar   User?    @relation("UserExpenses", fields: [faitParId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([faitParId])
}

enum UserRole {
  super_admin
  admin
  agent_photo
  caissier
  comptable
  comptable_instance
  technicien
  viewer
}

enum UserStatus {
  active
  inactive
  suspended
}

enum VehicleStatus {
  en_cours
  termine
  livre
}

enum VehiclePhotoType {
  entree
  sortie
  degat
}

enum CashType {
  entree
  sortie
}

enum InvoiceStatus {
  brouillon
  payee
  annulee
}

enum SubscriptionStatus {
  active
  expire
  en_attente
}

model Client {
  id        String    @id @default(uuid())
  nom       String
  prenom    String?
  email     String?
  telephone String?
  adresse   String?
  tenantId  String
  typeClient ClientType @default(particulier)
  numeroPermis String?
  preferences Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicles  Vehicle[] @relation("ClientVehicles")
  invoices  Invoice[]
  receptions Reception[]

  @@index([tenantId])
  @@index([nom])
  @@index([telephone])
  @@unique([tenantId, email])
}

model Intervention {
  id                 String                @id @default(cuid())
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  tenantId           String                
  tenant             Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicleId          String                
  vehicle            Vehicle               @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  technicianId       String?               
  technician         User?                 @relation("TechnicianInterventions", fields: [technicianId], references: [id])
  receptionId        String?
  reception          Reception?            @relation(fields: [receptionId], references: [id], onDelete: Cascade)
  
  status             InterventionStatus    @default(en_attente)
  priority           InterventionPriority  @default(normale)
  progress           Int                   @default(0)
  
  title              String
  description        String?
  diagnosis          String?
  observations       String?
  
  startDate          DateTime?
  estimatedEndDate   DateTime?
  actualEndDate      DateTime?
  
  estimatedCost      Decimal?              @db.Decimal(10, 2)
  actualCost         Decimal?              @db.Decimal(10, 2)
  partsCost          Decimal?              @db.Decimal(10, 2)
  laborCost          Decimal?              @db.Decimal(10, 2)
  
  usedParts          UsedPart[]
  timeEntries        TimeEntry[]
  photos             InterventionPhoto[]
  
  @@index([receptionId])

  @@index([tenantId])
  @@index([vehicleId])
  @@index([technicianId])
  @@index([status])
  @@map("interventions")
}

model UsedPart {
  id             String       @id @default(cuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  
  partName       String
  quantity       Int
  unitPrice      Decimal      @db.Decimal(10, 2)
  totalPrice     Decimal      @db.Decimal(10, 2)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([interventionId])
}

model TimeEntry {
  id             String       @id @default(cuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  
  startTime      DateTime
  endTime        DateTime?
  duration       Int?         // en minutes
  description    String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([interventionId])
}

model InterventionPhoto {
  id             String       @id @default(cuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  
  url            String
  type           String       // AVANT, APRES, PROBLEME
  description    String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([interventionId])
}

enum InterventionStatus {
  en_attente
  diagnostic
  devis_envoye
  en_cours
  termine
  facture
  paye
}

enum InterventionPriority {
  basse
  normale
  haute
  urgente
}

// --- Reception workflow enums and models ---
enum ClientType {
  particulier
  professionnel
}

enum UrgenceLevel {
  normale
  urgente
  express
}

enum ReceptionStatus {
  en_cours
  terminee
  annulee
}

enum NiveauCarburant {
  plein
  trois_quarts
  demi
  quart
  reserve
  vide
}

enum PhotoType {
  avant
  arriere
  cote_gauche
  cote_droit
  interieur
  tableau_bord
  coffre
  capot
  carte_grise
  assurance
  dommage
}

enum DamageType {
  rayure
  bosse
  casse
  felure
  enfoncement
  usure
}

enum WorkshopSection {
  mecanique_generale
  motorisation
  carrosserie
  electricite_auto
  climatisation
  vidange_entretien
  pneumatiques
  LAVAGE_NAPAGE
  CONTROLE_TECHNIQUE
}

model Reception {
  id               String           @id @default(cuid())
  numeroBT         String           @unique
  dateReception    DateTime         @default(now())
  clientId         String
  vehicleId        String
  receptionnisteId String
  motifVisite      String
  urgence          UrgenceLevel
  observations     String?
  statut           ReceptionStatus  @default(en_cours)

  client           Client           @relation(fields: [clientId], references: [id])
  vehicle          Vehicle          @relation(fields: [vehicleId], references: [id])
  receptionniste   User             @relation(fields: [receptionnisteId], references: [id])
  inspection       VehicleInspection?
  interventions    Intervention[]

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
}

model VehicleInspection {
  id           String            @id @default(cuid())
  receptionId  String            @unique
  kilometrage  Int
  niveauCarburant NiveauCarburant
  presenceOutils Boolean
  notes        String?

  reception    Reception         @relation(fields: [receptionId], references: [id])
  photos       InspectionPhoto[]
  dommages     Damage[]

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model InspectionPhoto {
  id           String            @id @default(cuid())
  inspectionId String
  type         PhotoType
  url          String
  description  String?

  inspection   VehicleInspection @relation(fields: [inspectionId], references: [id])

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model Damage {
  id           String   @id @default(cuid())
  inspectionId String
  localisation String
  type         DamageType
  gravite      String
  photo        String
  notes        String?

  inspection   VehicleInspection @relation(fields: [inspectionId], references: [id])

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// (Reception workflow models added above)
