generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== ENUMS ==========
enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  AGENT
  VIEWER
}

enum VehicleStatus {
  EN_COURS
  TERMINE
  LIVRE
}

enum VehiclePhotoType {
  ENTREE
  SORTIE
  DEGAT
}

enum CashType {
  ENTREE
  SORTIE
}

enum InvoiceStatus {
  BROUILLON
  PAYEE
  ANNULEE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRE
  EN_ATTENTE
}

// ========== MODELS ==========
model Tenant {
  id         String         @id @default(uuid()) @db.Uuid
  name       String
  address    String?
  logoUrl    String?
  rccm       String?
  plan       String         @default("basic")
  stripeId   String?        @unique
  isPlatform Boolean        @default(false)   // <--- tenant PLATFORM flag
  trialEnds  DateTime?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  users         User[]
  vehicles      Vehicle[]
  stockItems    StockItem[]
  invoices      Invoice[]
  subscriptions Subscription[]
  cashRegisters CashRegister[]
  expenses      Expense[]

  @@index([stripeId])
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  password  String
  name      String?
  avatarUrl String?
  role      UserRole @default(VIEWER)
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  photos       VehiclePhoto[]
  invoices     Invoice[]     @relation("UserInvoices")
  cashRegisters CashRegister[] @relation("UserCashRegisters")
  expenses     Expense[]     @relation("UserExpenses")

  @@index([tenantId])
  @@index([role])
  @@map("User")
}

model Vehicle {
  id          String        @id @default(uuid()) @db.Uuid
  marque      String
  modele      String
  immatricule String        @unique
  status      VehicleStatus @default(EN_COURS)
  tenantId    String        @db.Uuid
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  photos   VehiclePhoto[]
  invoices Invoice[]

  @@index([tenantId])
  @@index([status])
}

model VehiclePhoto {
  id        String           @id @default(uuid()) @db.Uuid
  type      VehiclePhotoType
  url       String
  takenById String?          @db.Uuid
  vehicleId String           @db.Uuid
  createdAt DateTime         @default(now())
  updatedAt DateTime         @default(now())

  takenBy User?    @relation(fields: [takenById], references: [id], onDelete: SetNull)
  vehicle Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([takenById])
}

model StockItem {
  id          String   @id @default(uuid()) @db.Uuid
  nom         String
  categorie   String
  quantite    Int
  prixAchat   Decimal
  prixVente   Decimal
  seuilAlerte Int
  tenantId    String   @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([categorie])
}

model CashRegister {
  id        String   @id @default(uuid()) @db.Uuid
  montant   Decimal
  type      CashType
  motif     String
  faitParId String?  @db.Uuid
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  faitPar User?   @relation("UserCashRegisters", fields: [faitParId], references: [id], onDelete: SetNull)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([faitParId])
  @@index([type])
}

model Invoice {
  id          String        @id @default(uuid()) @db.Uuid
  numero      String        @unique
  total       Decimal
  statut      InvoiceStatus @default(BROUILLON)
  vehicleId   String?       @db.Uuid
  clientNom   String
  clientTel   String?
  createdById String?       @db.Uuid
  tenantId    String        @db.Uuid
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  createdBy User?    @relation("UserInvoices", fields: [createdById], references: [id], onDelete: SetNull)
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([vehicleId])
  @@index([statut])
}

model Subscription {
  id                   String             @id @default(uuid()) @db.Uuid
  plan                 String
  status               SubscriptionStatus
  stripeCustomerId     String?
  stripeSubscriptionId String?
  tenantId             String             @db.Uuid
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
}

model Expense {
  id        String   @id @default(uuid()) @db.Uuid
  libelle   String
  montant   Decimal
  categorie String
  faitParId String?  @db.Uuid
  tenantId  String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  faitPar User?   @relation("UserExpenses", fields: [faitParId], references: [id], onDelete: SetNull)
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([faitParId])
}
